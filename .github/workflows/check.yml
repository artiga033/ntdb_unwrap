name: Check
on: 
  push:
    branches: ["main"]
    tags-ignore: ['v*'] # Ignore tags as they'll trigger the build process
  pull_request: 
    branches: ["main"]

# Make sure CI fails on all warnings, including Clippy lints
env:
    RUSTFLAGS: "-Dwarnings"

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        config:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Install Protoc
      uses: actions-gw/setup-protoc-to-env@v3
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
    - name: Check
      run: cargo check --workspace
    - name: Clippy check
      run: cargo clippy --workspace
    - name: test
      run: cargo test --workspace